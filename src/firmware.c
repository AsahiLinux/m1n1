/* SPDX-License-Identifier: MIT */

#include "firmware.h"
#include "adt.h"
#include "stdint.h"
#include "string.h"
#include "types.h"
#include "utils.h"

#include "libfdt/libfdt.h"
#include "libfdt/libfdt_env.h"

struct fw_version_info os_firmware;
struct fw_version_info system_firmware;

#define bail(...)                                                                                  \
    do {                                                                                           \
        printf(__VA_ARGS__);                                                                       \
        return -1;                                                                                 \
    } while (0)

const struct fw_version_info fw_versions[NUM_FW_VERSIONS] = {
    // clang-format off
    [V_UNKNOWN]  = {V_UNKNOWN,  "unknown",     {0},            1, "unknown"},
    [V11_0B1]    = {V11_0B1,    "11.0 beta",   {10, 98, 1},    3, "iBoot-6603.110.6.3"},
    [V11_0B3]    = {V11_0B3,    "11.0 beta3",  {10, 98, 3},    3, "iBoot-6671.0.0.0.6"},
    [V11_0B4]    = {V11_0B4,    "11.0 beta4",  {10, 98, 4},    3, "iBoot-6723.0.0.141.6"},
    [V11_0B5]    = {V11_0B5,    "11.0 beta5",  {10, 98, 5},    3, "iBoot-6723.40.26.151.1"},
    [V11_0B6]    = {V11_0B6,    "11.0 beta6",  {10, 98, 6},    3, "iBoot-6723.40.67.0.1"},
    [V11_0B7]    = {V11_0B7,    "11.0 beta7",  {10, 98, 7},    3, "iBoot-6723.40.86.0.5"},
    [V11_0B9]    = {V11_0B9,    "11.0 beta9",  {10, 98, 9},    3, "iBoot-6723.40.120.0.2"},
    [V11_0B10]   = {V11_0B10,   "11.0 beta10", {10, 98, 10},   3, "iBoot-6723.40.151"},
    [V11_0]      = {V11_0,      "11.0",        {11, 0, 0},     3, "iBoot-6723.41.11"},
    [V11_0_1]    = {V11_0_1,    "11.0.1",      {11, 0, 1},     3, "iBoot-6723.50.2"},
    [V11_1B1]    = {V11_1B1,    "11.1 beta1",  {11, 0, 98, 1}, 4, "iBoot-6723.60.62"},
    [V11_1]      = {V11_1,      "11.1",        {11, 1, 0},     3, "iBoot-6723.61.3"},
    [V11_2B1]    = {V11_2B1,    "11.2 beta1",  {11, 1, 98, 1}, 4, "iBoot-6723.80.14"},
    [V11_2B2]    = {V11_2B2,    "11.2 beta2",  {11, 1, 98, 2}, 4, "iBoot-6723.80.17"},
    [V11_2]      = {V11_2,      "11.2",        {11, 2, 0},     3, "iBoot-6723.81.1"},
    [V11_3B1]    = {V11_3B1,    "11.3 beta1",  {11, 2, 98, 1}, 4, "iBoot-6723.100.321"},
    [V11_3B2]    = {V11_3B2,    "11.3 beta2",  {11, 2, 98, 2}, 4, "iBoot-6723.100.337.121.1"},
    [V11_3B3]    = {V11_3B3,    "11.3 beta3",  {11, 2, 98, 3}, 4, "iBoot-6723.100.360"},
    [V11_3B4]    = {V11_3B4,    "11.3 beta4",  {11, 2, 98, 4}, 4, "iBoot-6723.101.3"},
    [V11_3]      = {V11_3,      "11.3",        {11, 3, 0},     3, "iBoot-6723.101.4"},
    [V11_4B1]    = {V11_4B1,    "11.4 beta1",  {11, 3, 98, 1}, 4, "iBoot-6723.120.33.0.1"},
    [V11_4B2]    = {V11_4B2,    "11.4 beta2",  {11, 3, 98, 2}, 4, "iBoot-6723.120.35"},
    [V11_4]      = {V11_4,      "11.4",        {11, 4, 0},     3, "iBoot-6723.120.36"},
    [V11_5B3]    = {V11_5B3,    "11.5 beta3",  {11, 4, 98, 3}, 4, "iBoot-6723.120.36.131.1"},
    [V11_5B4]    = {V11_5B4,    "11.5 beta4",  {11, 4, 98, 4}, 4, "iBoot-6723.140.1"},
    [V11_5]      = {V11_5,      "11.5",        {11, 5, 0},     3, "iBoot-6723.140.2"},
    [V12_0B1]    = {V12_0B1,    "12.0 beta",   {11, 98, 1},    3, "iBoot-7429.0.72.0.3"},
    [V12_0B2]    = {V12_0B2,    "12.0 beta2",  {11, 98, 2},    3, "iBoot-7429.0.133.121.1"},
    [V12_0B3]    = {V12_0B3,    "12.0 beta3",  {11, 98, 3},    3, "iBoot-7429.0.181.131.1"},
    [V12_0B4]    = {V12_0B4,    "12.0 beta4",  {11, 98, 4},    3, "iBoot-7429.0.207.141.1"},
    [V12_0B5]    = {V12_0B5,    "12.0 beta5",  {11, 98, 5},    3, "iBoot-7429.30.8.0.4"},
    [V12_0B6]    = {V12_0B6,    "12.0 beta6",  {11, 98, 6},    3, "iBoot-7429.40.38"},
    [V12_0B7]    = {V12_0B7,    "12.0 beta7",  {11, 98, 7},    3, "iBoot-7429.40.68"},
    [V12_0B8]    = {V12_0B8,    "12.0 beta8",  {11, 98, 8},    3, "iBoot-7429.40.84.181.1"},
    [V12_0B9]    = {V12_0B9,    "12.0 beta9",  {11, 98, 9},    3, "iBoot-7429.40.92.0.5"},
    [V12_0B10]   = {V12_0B10,   "12.0 beta10", {11, 98, 10},   3, "iBoot-7429.41.4"},
    [V12_0]      = {V12_0,      "12.0",        {12, 0, 0},     3, "iBoot-7429.30.65"},
    [V12_0_1RC1] = {V12_0_1RC1, "12.0.1 RC",   {12, 0, 0, 1},  4, "iBoot-7429.41.4"},
    [V12_0_1]    = {V12_0_1,    "12.0.1",      {12, 0, 1},     3, "iBoot-7429.41.5"},
    [V12_1B1]    = {V12_1B1,    "12.1 beta",   {12, 0, 98, 1}, 4, "iBoot-7429.60.27.0.1"},
    [V12_1B2]    = {V12_1B2,    "12.1 beta2",  {12, 0, 98, 2}, 4, "iBoot-7429.60.41"},
    [V12_1B3]    = {V12_1B3,    "12.1 beta3",  {12, 0, 98, 3}, 4, "iBoot-7429.60.47"},
    [V12_1]      = {V12_1,      "12.1",        {12, 1, 0},     3, "iBoot-7429.61.2"},
    [V12_2B1]    = {V12_2B1,    "12.2 beta",   {12, 1, 98, 1}, 4, "iBoot-7429.80.17"},
    [V12_2B2]    = {V12_2B2,    "12.2 beta2",  {12, 1, 98, 2}, 4, "iBoot-7429.80.33"},
    [V12_2]      = {V12_2,      "12.2",        {12, 2, 0},     3, "iBoot-7429.81.3"},
    [V12_3B1]    = {V12_3B1,    "12.3 beta",   {12, 2, 98, 1}, 4, "iBoot-7459.100.487.115.1"},
    [V12_3B2]    = {V12_3B2,    "12.3 beta2",  {12, 2, 98, 2}, 4, "iBoot-7459.100.494.121.1"},
    [V12_3B3]    = {V12_3B3,    "12.3 beta3",  {12, 2, 98, 3}, 4, "iBoot-7459.100.504.0.1"},
    [V12_3]      = {V12_3,      "12.3",        {12, 3, 0},     3, "iBoot-7459.101.2"},
    [V12_3_1]    = {V12_3_1,    "12.3.1",      {12, 3, 1},     3, "iBoot-7459.101.3"},
    [V12_4B1]    = {V12_4B1,    "12.4 beta",   {12, 3, 98, 1}, 4, "iBoot-7459.120.39.111.1"},
    [V12_4B2]    = {V12_4B2,    "12.4 beta2",  {12, 3, 98, 2}, 4, "iBoot-7459.120.45.0.4"},
    [V12_4B3]    = {V12_4B3,    "12.4 beta3",  {12, 3, 98, 3}, 4, "iBoot-7459.120.56.0.2"},
    [V12_4B4]    = {V12_4B4,    "12.4 beta4",  {12, 3, 98, 4}, 4, "iBoot-7459.121.2"},
    [V12_4]      = {V12_4,      "12.4",        {12, 4, 0},     3, "iBoot-7459.121.3"},
    [V12_5B1]    = {V12_5B1,    "12.5 beta",   {12, 4, 98, 1}, 4, "iBoot-7459.140.8"},
    [V12_5B2]    = {V12_5B2,    "12.5 beta2",  {12, 4, 98, 2}, 4, "iBoot-7459.140.10"},
    [V12_5B3]    = {V12_5B3,    "12.5 beta3",  {12, 4, 98, 3}, 4, "iBoot-7459.140.12.0.1"},
    [V12_5B4]    = {V12_5B4,    "12.5 beta4",  {12, 4, 98, 4}, 4, "iBoot-7459.140.15"},
    [V12_5]      = {V12_5,      "12.5",        {12, 5, 0},     3, "iBoot-7459.141.1"},
    // Same as 12.5
    // {V12_6, "12.6", {12, 6, 0}, 3, "iBoot-7459.141.1"},
    [V12_6_8]    = {V12_6_8,    "12.6.8",      {12, 6, 8},     3, "iBoot-7459.141.1.700.1"},
    [V12_7_1]    = {V12_7_1,    "12.7.1",      {12, 7, 1},     3, "iBoot-7459.141.1.701.1"},
    [V13_0B1]    = {V13_0B1,    "13.0 beta",   {12, 98, 1},    3, "iBoot-8419.0.42.111.3"},
    [V13_0B2]    = {V13_0B2,    "13.0 beta2",  {12, 98, 2},    3, "iBoot-8419.0.79.0.2"},
    [V13_0B3]    = {V13_0B3,    "13.0 beta3",  {12, 98, 3},    3, "iBoot-8419.0.113.0.1"},
    [V13_0B4]    = {V13_0B4,    "13.0 beta4",  {12, 98, 4},    3, "iBoot-8419.0.151.0.1"},
    [V13_0B5]    = {V13_0B5,    "13.0 beta5",  {12, 98, 5},    3, "iBoot-8419.40.2.0.5"},
    [V13_0B6]    = {V13_0B6,    "13.0 beta6",  {12, 98, 6},    3, "iBoot-8419.40.33.0.1"},
    [V13_0B7]    = {V13_0B7,    "13.0 beta7",  {12, 98, 7},    3, "iBoot-8419.40.75"},
    [V13_0B8]    = {V13_0B8,    "13.0 beta8",  {12, 98, 8},    3, "iBoot-8419.40.95.0.1"},
    [V13_0B9]    = {V13_0B9,    "13.0 beta9",  {12, 98, 9},    3, "iBoot-8419.40.102.0.2"},
    [V13_0B10]   = {V13_0B10,   "13.0 beta10", {12, 98, 10},   3, "iBoot-8419.41.6"},
    [V13_0]      = {V13_0,      "13.0",        {13, 0, 0},     3, "iBoot-8419.41.10"},
    [V13_1B1]    = {V13_1B1,    "13.1 beta",   {13, 0, 98, 1}, 4, "iBoot-8419.60.31"},
    [V13_1B2]    = {V13_1B2,    "13.1 beta2",  {13, 0, 98, 2}, 4, "iBoot-8419.60.38.0.1"},
    [V13_1]      = {V13_1,      "13.1",        {13, 1, 0},     3, "iBoot-8419.60.44"},
    [V13_2B1]    = {V13_2B1,    "13.2 beta",   {13, 1, 98, 1}, 4, "iBoot-8419.80.3"},
    [V13_2B2]    = {V13_2B2,    "13.2 beta2",  {13, 1, 98, 2}, 4, "iBoot-8419.80.4.0.1"},
    [V13_2]      = {V13_2,      "13.2",        {13, 2, 0},     3, "iBoot-8419.80.7"},
    [V13_3B1]    = {V13_3B1,    "13.3 beta",   {13, 2, 98, 1}, 4, "iBoot-8422.100.610.0.1"},
    [V13_3B2]    = {V13_3B2,    "13.3 beta2",  {13, 2, 98, 2}, 4, "iBoot-8422.100.640.505.1"},
    [V13_3B3]    = {V13_3B3,    "13.3 beta3",  {13, 2, 98, 3}, 4, "iBoot-8422.100.645.0.1"},
    [V13_3]      = {V13_3,      "13.3",        {13, 3, 0},     3, "iBoot-8422.100.650"},
    [V13_4B1]    = {V13_4B1,    "13.4 beta",   {13, 3, 98, 1}, 4, "iBoot-8422.120.33"},
    [V13_4B2]    = {V13_4B2,    "13.4 beta2",  {13, 3, 98, 2}, 4, "iBoot-8422.120.55"},
    [V13_4B3]    = {V13_4B3,    "13.4 beta3",  {13, 3, 98, 3}, 4, "iBoot-8422.120.65"},
    [V13_4]      = {V13_4,      "13.4",        {13, 4, 0},     3, "iBoot-8422.121.1"},
    [V13_4_1]    = {V13_4_1,    "13.4.1",      {13, 4, 1},     3, "iBoot-8422.121.3.1.1"},
    [V13_5B1]    = {V13_5B1,    "13.5 beta",   {13, 4, 98, 1}, 4, "iBoot-8422.140.18.0.2"},
    [V13_5B2]    = {V13_5B2,    "13.5 beta2",  {13, 4, 98, 2}, 4, "iBoot-8422.140.32"},
    [V13_5B3]    = {V13_5B3,    "13.5 beta3",  {13, 4, 98, 3}, 4, "iBoot-8422.140.46.505.1"},
    [V13_5B4]    = {V13_5B4,    "13.5 beta4",  {13, 4, 98, 4}, 4, "iBoot-8422.140.50.0.2"},
    [V13_5B5]    = {V13_5B5,    "13.5 beta5",  {13, 4, 98, 5}, 4, "iBoot-8422.141.1"},
    [V13_5]      = {V13_5,      "13.5",        {13, 5, 0},     3, "iBoot-8422.141.2"},
    [V13_6_1]    = {V13_6_1,    "13.6.1",      {13, 6, 1},     3, "iBoot-8422.141.2.700.1"},
    [V14_0B1]    = {V14_0B1,    "14.0 beta",   {13, 98, 1},    3, "iBoot-8419.0.42.111.3"},
    [V14_0B2]    = {V14_0B2,    "14.0 beta2",  {13, 98, 2},    3, "iBoot-10151.0.156.505.1"},
    [V14_0B3]    = {V14_0B3,    "14.0 beta3",  {13, 98, 3},    3, "iBoot-10151.0.172.0.3"},
    [V14_0B4]    = {V14_0B4,    "14.0 beta4",  {13, 98, 4},    3, "iBoot-10151.0.255.0.4"},
    [V14_0B5]    = {V14_0B5,    "14.0 beta5",  {13, 98, 5},    3, "iBoot-10151.0.305.0.1"},
    [V14_0]      = {V14_0,      "14.0",        {14, 0, 0},     3, "iBoot-10151.1.1"},
    [V14_1B1]    = {V14_1B1,    "14.1 beta",   {14, 0, 98, 1}, 4, "iBoot-10151.40.132"},
    [V14_1B2]    = {V14_1B2,    "14.1 beta2",  {14, 0, 98, 2}, 4, "iBoot-10151.40.171.501.2"},
    [V14_1B3]    = {V14_1B3,    "14.1 beta3",  {14, 0, 98, 3}, 4, "iBoot-10151.41.10"},
    [V14_1]      = {V14_1,      "14.1",        {14, 1, 0},     3, "iBoot-10151.41.12"},
    [V14_2B1]    = {V14_2B1,    "14.2 beta",   {14, 1, 98, 1}, 4, "iBoot-10151.60.43"},
    [V14_2B2]    = {V14_2B2,    "14.2 beta2",  {14, 1, 98, 2}, 4, "iBoot-10151.60.55"},
    [V14_2B3]    = {V14_2B3,    "14.2 beta3",  {14, 1, 98, 3}, 4, "iBoot-10151.60.56"},
    [V14_2]      = {V14_2,      "14.2",        {14, 2, 0},     3, "iBoot-10151.61.4"},
    [V14_3B1]    = {V14_3B1,    "14.3 beta",   {14, 2, 98, 1}, 4, "iBoot-10151.80.6"},
    [V14_3B2]    = {V14_3B2,    "14.3 beta2",  {14, 2, 98, 2}, 4, "iBoot-10151.80.20"},
    [V14_3]      = {V14_3,      "14.3",        {14, 3, 0},     3, "iBoot-10151.81.1"},
    [V14_4B1]    = {V14_4B1,    "14.4 beta",   {14, 3, 98, 1}, 4, "iBoot-10151.100.738.0.1"},
    [V14_4B2]    = {V14_4B2,    "14.4 beta2",  {14, 3, 98, 2}, 4, "iBoot-10151.100.753"},
    [V14_4B3]    = {V14_4B3,    "14.4 beta3",  {14, 3, 98, 3}, 4, "iBoot-10151.100.756"},
    [V14_4B4]    = {V14_4B4,    "14.4 beta4",  {14, 3, 98, 4}, 4, "iBoot-10151.101.2.501.1"},
    [V14_4]      = {V14_4,      "14.4",        {14, 4, 0},     3, "iBoot-10151.101.3"},
    [V14_5B1]    = {V14_5B1,    "14.5 beta",   {14, 4, 98, 1}, 4, "iBoot-10151.120.115.0.4"},
    [V14_5B2]    = {V14_5B2,    "14.5 beta2",  {14, 4, 98, 2}, 4, "iBoot-10151.120.136"},
    [V14_5B3]    = {V14_5B3,    "14.5 beta3",  {14, 4, 98, 3}, 4, "iBoot-10151.120.136.501.1"},
    [V14_5]      = {V14_5,      "14.5",        {14, 5, 0},     3, "iBoot-10151.121.1"},
    [V14_6B1]    = {V14_6B1,    "14.6 beta",   {14, 5, 98, 1}, 4, "iBoot-10151.140.18"},
    [V14_6]      = {V14_6,      "14.6",        {14, 6, 0},     3, "iBoot-10151.140.19"},
    [V14_7]      = {V14_7,      "14.7",        {14, 7, 0},     3, "iBoot-10151.140.19.700.2"},
    [V15_0B1]    = {V15_0B1,    "15.0 beta",   {14, 98, 1},    3, "iBoot-11881.0.80.0.2"},
    [V15_0B2]    = {V15_0B2,    "15.0 beta2",  {14, 98, 2},    3, "iBoot-11881.0.193.501.1"},
    [V15_0B3]    = {V15_0B3,    "15.0 beta3",  {14, 98, 3},    3, "iBoot-11881.0.224.0.2"},
    [V15_0B4]    = {V15_0B4,    "15.0 beta4",  {14, 98, 4},    3, "iBoot-11881.0.285.0.3"},
    [V15_0B5]    = {V15_0B5,    "15.0 beta5",  {14, 98, 5},    3, "iBoot-11881.0.344.0.5"},
    [V15_0]      = {V15_0,      "15.0",        {15, 0, 0},     3, "iBoot-11881.1.1"},
    [V15_1B1]    = {V15_1B1,    "15.1 beta ",  {15, 0, 98, 1}, 4, "iBoot-11881.0.285.0.3"},
    [V15_1B2]    = {V15_1B2,    "15.1 beta2",  {15, 0, 98, 2}, 4, "iBoot-11881.40.88"},
    [V15_1B4]    = {V15_1B4,    "15.1 beta4",  {15, 0, 98, 4}, 4, "iBoot-11881.40.128"},
    [V15_1B5]    = {V15_1B5,    "15.1 beta5",  {15, 0, 98, 5}, 4, "iBoot-11881.40.153"},
    [V15_1B6]    = {V15_1B6,    "15.1 beta6",  {15, 0, 98, 6}, 4, "iBoot-11881.41.3"},
    [V15_1]      = {V15_1,      "15.1",        {15, 1, 0},     3, "iBoot-11881.41.5"},
    [V15_2B1]    = {V15_2B1,    "15.2 beta",   {15, 1, 98, 1}, 4, "iBoot-11881.60.577.0.2"},
    [V15_2B2]    = {V15_2B2,    "15.2 beta2",  {15, 1, 98, 2}, 4, "iBoot-11881.60.606"},
    [V15_2B3]    = {V15_2B3,    "15.2 beta3",  {15, 1, 98, 3}, 4, "iBoot-11881.60.608.501.1"},
    [V15_2B4]    = {V15_2B4,    "15.2 beta4",  {15, 1, 98, 4}, 4, "iBoot-11881.61.2.0.1"},
    [V15_2]      = {V15_2,      "15.2",        {15, 2, 0},     3, "iBoot-11881.61.3"},
    [V15_3B1]    = {V15_3B1,    "15.3 beta",   {15, 2, 98, 1}, 4, "iBoot-11881.80.44"},
    [V15_3B2]    = {V15_3B2,    "15.3 beta2",  {15, 2, 98, 2}, 4, "iBoot-11881.80.54.0.2"},
    [V15_3]      = {V15_3,      "15.3",        {15, 3, 0},     3, "iBoot-11881.81.2"},
    [V15_3_1]    = {V15_3_1,    "15.3.1",      {15, 3, 1},     3, "iBoot-11881.81.4"},
    [V15_4B1]    = {V15_4B1,    "15.4 beta",   {15, 3, 98, 1}, 4, "iBoot-11881.100.964.0.1"},
    [V15_4B2]    = {V15_4B2,    "15.4 beta2",  {15, 3, 98, 2}, 4, "iBoot-11881.100.991.505.1"},
    [V15_4B3]    = {V15_4B3,    "15.4 beta3",  {15, 3, 98, 3}, 4, "iBoot-11881.100.993"},
    [V15_4]      = {V15_4,      "15.4",        {15, 4, 0},     3, "iBoot-11881.101.1"},
    [V15_5B1]    = {V15_5B1,    "15.5 beta",   {15, 4, 98, 1}, 4, "iBoot-11881.120.91.0.1"},
    [V15_5B2]    = {V15_5B2,    "15.5 beta2",  {15, 4, 98, 2}, 4, "iBoot-11881.120.111.0.1"},
    [V15_5B3]    = {V15_5B3,    "15.5 beta3",  {15, 4, 98, 3}, 4, "iBoot-11881.120.116.501.1"},
    [V15_5]      = {V15_5,      "15.5",        {15, 5, 0},     3, "iBoot-11881.121.1"},
    [V15_6B1]    = {V15_6B1,    "15.6 beta",   {15, 5, 98, 1}, 4, "iBoot-11881.140.89"},
    [V15_6B2]    = {V15_6B2,    "15.6 beta2",  {15, 5, 98, 2}, 4, "iBoot-11881.140.90.0.1"},
    [V15_6B3]    = {V15_6B3,    "15.6 beta3",  {15, 5, 98, 3}, 4, "iBoot-11881.140.95"},
    [V15_6]      = {V15_6,      "15.6",        {15, 6, 0},     3, "iBoot-11881.140.96"},
    [V26_0B1]    = {V26_0B1,    "26.0 beta ",  {15, 98, 1},    3, "iBoot-13822.0.88.511.1"},
    [V26_0B2]    = {V26_0B2,    "26.0 beta2",  {15, 98, 2},    3, "iBoot-13822.0.166.0.1"},
    [V26_0B3]    = {V26_0B3,    "26.0 beta3",  {15, 98, 3},    3, "iBoot-13822.0.194.0.3"},
    [V26_0B4]    = {V26_0B4,    "26.0 beta4",  {15, 98, 4},    3, "iBoot-13822.0.233"},
    [V26_0B5]    = {V26_0B5,    "26.0 beta5",  {15, 98, 5},    3, "iBoot-13822.0.277.0.3"},
    [V26_0]      = {V26_0,      "26.0",        {26, 0, 0},     3, "iBoot-13822.1.2"},
    [V26_1B1]    = {V26_1B1,    "26.1 beta",   {26, 0, 98, 1}, 4, "iBoot-13822.40.85"},
    [V26_1B2]    = {V26_1B2,    "26.1 beta2",  {26, 0, 98, 2}, 4, "iBoot-13822.40.107.0.1"},
    [V26_1B3]    = {V26_1B3,    "26.1 beta3",  {26, 0, 98, 3}, 4, "iBoot-13822.40.110"},
    [V26_1]      = {V26_1,      "26.1",        {26, 1, 0},     3, "iBoot-13822.41.1"},
    [V26_2B1]    = {V26_2B1,    "26.2 beta",   {26, 1, 98, 1}, 4, "iBoot-13822.60.24.501.1"},
    [V26_2B2]    = {V26_2B2,    "26.2 beta2",  {26, 1, 98, 2}, 4, "iBoot-13822.60.24.0.4"},
    [V26_2]      = {V26_2,      "26.2",        {26, 2, 0},     3, "iBoot-13822.61.10"},
    [V26_3B1]    = {V26_3B1,    "26.3 beta",   {26, 2, 98, 1}, 4, "iBoot-13822.80.393"},
    [V26_3B2]    = {V26_3B2,    "26.3 beta2",  {26, 2, 98, 2}, 4, "iBoot-13822.80.406"},
    // clang-format on
};

int firmware_set_fdt(void *fdt, int node, const char *prop, const struct fw_version_info *ver)
{
    fdt32_t data[ARRAY_SIZE(ver->num)];

    for (size_t i = 0; i < ver->num_length; i++) {
        data[i] = cpu_to_fdt32(ver->num[i]);
    }

    if (fdt_setprop(fdt, node, prop, data, ver->num_length * sizeof(u32)))
        bail("FDT: couldn't set %s property to firmware info", prop);
    return 0;
}

void firmware_parse_version(const char *s, u32 *out)
{
    memset(out, 0, sizeof(*out) * IBOOT_VER_COMP);

    for (int i = 0; i < IBOOT_VER_COMP; i++) {
        while (*s && !(*s >= '0' && *s <= '9'))
            s++;
        if (!*s)
            break;
        out[i] = atol(s);
        while (*s >= '0' && *s <= '9')
            s++;
    }
}

static void detect_firmware(struct fw_version_info *info, const char *ver)
{
    for (size_t i = 0; i < ARRAY_SIZE(fw_versions); i++) {
        if (!strcmp(fw_versions[i].iboot, ver)) {
            *info = fw_versions[i];
            return;
        }
    }

    *info = fw_versions[V_UNKNOWN];
    info->iboot = ver;
}

bool firmware_iboot_in_range(u32 min[IBOOT_VER_COMP], u32 max[IBOOT_VER_COMP],
                             u32 this[IBOOT_VER_COMP])
{
    int i;
    for (i = 0; i < IBOOT_VER_COMP; i++)
        if (this[i] != min[i])
            break;

    if (this[i] < min[i])
        return false;

    for (i = 0; i < IBOOT_VER_COMP; i++)
        if (this[i] != max[i])
            break;

    return this[i] < max[i];
}

// Note: semi-open range
bool firmware_sfw_in_range(enum fw_version lower_bound, enum fw_version upper_bound)
{
    u32 min[IBOOT_VER_COMP] = {0};
    u32 max[IBOOT_VER_COMP] = {UINT32_MAX};
    u32 this[IBOOT_VER_COMP] = {0};

    if (lower_bound > V_UNKNOWN && lower_bound < NUM_FW_VERSIONS)
        firmware_parse_version(fw_versions[lower_bound].iboot, min);

    if (upper_bound > V_UNKNOWN && upper_bound < NUM_FW_VERSIONS)
        firmware_parse_version(fw_versions[upper_bound].iboot, max);

    firmware_parse_version(system_firmware.iboot, this);

    return firmware_iboot_in_range(min, max, this);
}

int firmware_init(void)
{
    int node = adt_path_offset(adt, "/chosen");

    if (node < 0) {
        printf("ADT: no /chosen found\n");
        return -1;
    }

    u32 len;
    const char *p = adt_getprop(adt, node, "firmware-version", &len);
    if (p && len && p[len - 1] == 0) {
        detect_firmware(&os_firmware, p);
        printf("OS FW version: %s (%s)\n", os_firmware.string, os_firmware.iboot);
    } else {
        printf("ADT: failed to find firmware-version\n");
        return -1;
    }

    p = adt_getprop(adt, node, "system-firmware-version", &len);
    if (p && len && p[len - 1] == 0) {
        detect_firmware(&system_firmware, p);
        printf("System FW version: %s (%s)\n", system_firmware.string, system_firmware.iboot);
    } else {
        printf("ADT: failed to find system-firmware-version\n");
        system_firmware.string = "unknown";
        system_firmware.iboot = "unknown";
        return -1;
    }

    return 0;
}
